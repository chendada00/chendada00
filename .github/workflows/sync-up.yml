name: Sync to Upyun

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download and install upx
      run: |
        UPX_VERSION="v0.4.6"
        wget https://github.com/upyun/upx/releases/download/v0.4.6/upx_0.4.6_linux_386.tar.gz -O upx.tar.gz
        tar -xzf upx.tar.gz
        chmod +x upx
        sudo mv upx /usr/local/bin/

    - name: Create upx config file
      env:
        UPYUN_SERVICE: ${{ secrets.UPYUN_SERVICE }}
        UPYUN_OPERATOR: ${{ secrets.UPYUN_OPERATOR }}
        UPYUN_PASSWORD: ${{ secrets.UPYUN_PASSWORD }}
      run: |
        mkdir -p /home/runner/
        echo "[default]" > /home/runner/.upx.cfg
        echo "username = ${UPYUN_OPERATOR}" >> /home/runner/.upx.cfg
        echo "password = ${UPYUN_PASSWORD}" >> /home/runner/.upx.cfg
        echo "bucket = ${UPYUN_SERVICE}" >> /home/runner/.upx.cfg
        cat /home/runner/.upx.cfg  # 输出配置文件内容进行调试
        
    - name: Sync directories to Upyun
      env:
        UPYUN_SERVICE: ${{ secrets.UPYUN_SERVICE }}
        UPYUN_OPERATOR: ${{ secrets.UPYUN_OPERATOR }}
        UPYUN_PASSWORD: ${{ secrets.UPYUN_PASSWORD }}
      run: |
        # 同步第一个目录
        upx sync /snake /github/snake
